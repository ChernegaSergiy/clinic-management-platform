{% extends "layouts/dashboard.html.twig" %}

{% block title %}Clinic Management Platform{% endblock %}

{% block brand %}Clinic Admin{% endblock %}

{% block top_menu %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <div class="ui dropdown item" id="notificationDropdown">
            <i class="bell icon"></i> Сповіщення
            <div class="menu" id="notificationMenu">
                <div class="header">Сповіщення</div>
                <div class="ui divider"></div>
                <div class="item">Завантаження...</div>
            </div>
        </div>
        <div class="item">Вітаю,&nbsp;<a href="/user/profile">{{ session.user.first_name }}</a></div>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block mobile_menu %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/billing/contracts">Контракти</a>
        <a class="item" href="/admin/kpi_definitions">Налаштування KPI</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <a class="item" href="/admin/clinical">Клінічні довідники</a>
        <a class="item" href="/admin/auth_configs">Налаштування авторизації</a>
        {# Notification Dropdown for Mobile #}
        <div class="ui dropdown item" id="notificationDropdownMobile">
            <i class="bell icon"></i> Сповіщення
            <div class="menu" id="notificationMenuMobile">
                <div class="header">Сповіщення</div>
                <div class="ui divider"></div>
                <div class="item">Завантаження...</div>
            </div>
        </div>
        <div class="ui fitted divider"></div>
        <a class="item" href="/user/profile">Мій профіль</a>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block sidebar %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/billing/contracts">Контракти</a>
        <a class="item" href="/admin/kpi_definitions">Налаштування KPI</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <a class="item" href="/admin/clinical">Клінічні довідники</a>
        <a class="item" href="/admin/auth_configs">Налаштування авторизації</a>
        <div class="ui fitted divider"></div>
        <a class="item" href="/user/profile">Мій профіль</a>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {
            $('.message .close').on('click', function() {
                $(this).closest('.message').transition('fade');
            });

            // Initialize notification dropdowns
            $('#notificationDropdown').dropdown({
                onShow: function() {
                    markNotificationsAsRead();
                }
            });
            $('#notificationDropdownMobile').dropdown({
                onShow: function() {
                    markNotificationsAsRead();
                }
            });

            function fetchNotifications() {
                fetch('/api/notifications')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(notifications => {
                        updateNotificationDropdown(notifications);
                    })
                    .catch(error => {
                        console.error('Error fetching notifications:', error);
                        // Optionally display an error message in the dropdown
                    });
            }

            function updateNotificationDropdown(notifications) {
                const menu = $('#notificationMenu');
                const mobileMenu = $('#notificationMenuMobile');
                const notificationCount = notifications.length;

                // Clear previous items (except header and divider)
                menu.find('.item:not(.header):not(.divider)').remove();
                mobileMenu.find('.item:not(.header):not(.divider)').remove();

                if (notificationCount > 0) {
                    notifications.forEach(notification => {
                        const notificationItem = `
                            <div class="item">
                                <i class="bell outline icon"></i>
                                <div class="content">
                                    <div class="header">${notification.message}</div>
                                    <div class="description">${new Date(notification.created_at + 'Z').toLocaleString()}</div>
                                </div>
                            </div>
                        `;
                        menu.append(notificationItem);
                        mobileMenu.append(notificationItem);
                    });
                    // Optionally update a badge with the count
                } else {
                    const noNotificationItem = `
                        <div class="item">
                            <div class="content">
                                <div class="description">Немає нових сповіщень</div>
                            </div>
                        </div>
                    `;
                    menu.append(noNotificationItem);
                    mobileMenu.append(noNotificationItem);
                }
            }

            function markNotificationsAsRead() {
                fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // Empty body for POST request
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Optionally update UI to show no unread count
                        // Re-fetch to show updated status, or just clear badge
                        // fetchNotifications(); // Re-fetch to update content
                    }
                })
                .catch(error => {
                    console.error('Error marking notifications as read:', error);
                });
            }

            // Fetch notifications on page load
            fetchNotifications();

            // Optionally, fetch notifications periodically
            // setInterval(fetchNotifications, 60000); // every 60 seconds
        });
    </script>
{% endblock %}
