{% extends "layouts/dashboard.html.twig" %}

{% block title %}Clinic Management Platform{% endblock %}

{% block brand %}Clinic Admin{% endblock %}

{% block top_menu %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <div class="ui dropdown item" id="notificationDropdown">
            <i class="bell icon"></i> Сповіщення
            <span class="ui red circular mini label notification-badge" style="display: none;"></span>
            <div class="menu notification-menu" id="notificationMenu">
                <div class="header">Сповіщення</div>
                <div class="item notification-mark-all" id="notificationMarkAll"><i class="check icon"></i> Позначити всі як прочитані</div>
                <div class="ui divider"></div>
                <div class="item">Завантаження...</div>
            </div>
        </div>
        <div class="item">Вітаю,&nbsp;<a href="/user/profile">{{ session.user.first_name }}</a></div>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block mobile_menu %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/billing/contracts">Контракти</a>
        <a class="item" href="/admin/kpi_definitions">Налаштування KPI</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <a class="item" href="/admin/clinical">Клінічні довідники</a>
        <a class="item" href="/admin/auth_configs">Налаштування авторизації</a>
        {# Notification Dropdown for Mobile #}
        <div class="ui dropdown item" id="notificationDropdownMobile">
            <i class="bell icon"></i> Сповіщення
            <span class="ui red circular mini label notification-badge" style="display: none;"></span>
            <div class="menu notification-menu" id="notificationMenuMobile">
                <div class="header">Сповіщення</div>
                <div class="item notification-mark-all" id="notificationMarkAllMobile"><i class="check icon"></i> Позначити всі як прочитані</div>
                <div class="ui divider"></div>
                <div class="item">Завантаження...</div>
            </div>
        </div>
        <div class="ui fitted divider"></div>
        <a class="item" href="/user/profile">Мій профіль</a>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block sidebar %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/billing/contracts">Контракти</a>
        <a class="item" href="/admin/kpi_definitions">Налаштування KPI</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <a class="item" href="/admin/clinical">Клінічні довідники</a>
        <a class="item" href="/admin/auth_configs">Налаштування авторизації</a>
        <div class="ui fitted divider"></div>
        <a class="item" href="/user/profile">Мій профіль</a>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <style>
        .notification-item.unread .header {
            font-weight: 700;
        }
        .notification-menu {
            min-width: 320px;
            width: min(360px, 90vw);
            max-width: 420px;
            padding: 6px 0;
        }
        .notification-menu .item.notification-mark-all {
            font-weight: 600;
            color: #1b1c1d;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9fafb;
            cursor: pointer;
        }
        .notification-menu .item.notification-mark-all i.check.icon {
            color: #21ba45;
        }
        .notification-menu .item.notification-mark-all:hover {
            background: #f1f2f3;
        }
        .notification-menu .notification-item .content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            white-space: normal;
            word-break: break-word;
        }
        .notification-menu .notification-item .description {
            font-size: 11px;
            color: #767676;
        }
        .notification-menu .notification-item i.bell.outline.icon {
            color: #f2711c;
        }
        @media (max-width: 767px) {
            .notification-menu {
                width: 100%;
                min-width: 280px;
            }
        }
    </style>
    <script>
        $(document).ready(function() {
            $('.message .close').on('click', function() {
                $(this).closest('.message').transition('fade');
            });

            // Initialize notification dropdowns
            $('#notificationDropdown').dropdown();
            $('#notificationDropdownMobile').dropdown();

            function updateBadge(count) {
                $('.notification-badge').each(function() {
                    if (count > 0) {
                        $(this).text(count).show();
                    } else {
                        $(this).text('').hide();
                    }
                });
            }

            function fetchNotifications() {
                fetch('/api/notifications')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(notifications => {
                        updateNotificationDropdown(notifications);
                    })
                    .catch(error => {
                        console.error('Error fetching notifications:', error);
                        // Optionally display an error message in the dropdown
                    });
            }

            function formatDate(value) {
                try {
                    return new Date(value + 'Z').toLocaleString();
                } catch (e) {
                    return value;
                }
            }

            function updateNotificationDropdown(notifications) {
                const menu = $('#notificationMenu');
                const mobileMenu = $('#notificationMenuMobile');
                const notificationCount = notifications.length;

                // Clear previous items (except header and divider)
                menu.find('.item:not(.header):not(.divider)').remove();
                mobileMenu.find('.item:not(.header):not(.divider)').remove();

                updateBadge(notificationCount);

                if (notificationCount > 0) {
                    notifications.forEach(notification => {
                        const notificationItem = `
                            <div class="item notification-item unread">
                                <i class="bell outline icon"></i>
                                <div class="content">
                                    <div class="header">${notification.message}</div>
                                    <div class="description">${formatDate(notification.created_at)}</div>
                                </div>
                            </div>
                        `;
                        menu.append(notificationItem);
                        mobileMenu.append(notificationItem);
                    });
                    // Optionally update a badge with the count
                } else {
                    const noNotificationItem = `
                        <div class="item">
                            <div class="content">
                                <div class="description">Немає нових сповіщень</div>
                            </div>
                        </div>
                    `;
                    menu.append(noNotificationItem);
                    mobileMenu.append(noNotificationItem);
                }
            }

            function markNotificationsAsRead() {
                fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // Empty body for POST request
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateBadge(0);
                        // Mark current items as read visually
                        $('#notificationMenu .notification-item').removeClass('unread');
                        $('#notificationMenuMobile .notification-item').removeClass('unread');
                        // Optionally show empty state when dropdown opens again
                        // fetchNotifications();
                    }
                })
                .catch(error => {
                    console.error('Error marking notifications as read:', error);
                });
            }

            $('#notificationMarkAll, #notificationMarkAllMobile').on('click', function() {
                markNotificationsAsRead();
            });

            // Fetch notifications on page load
            fetchNotifications();

            // Optionally, fetch notifications periodically
            // setInterval(fetchNotifications, 60000); // every 60 seconds
        });
    </script>
{% endblock %}
