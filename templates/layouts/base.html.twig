{% extends "layouts/dashboard.html.twig" %}

{% block title %}Clinic Management Platform{% endblock %}

{% block brand %}Clinic Admin{% endblock %}

{% block top_menu %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <div class="ui dropdown item" id="notificationDropdown">
            <i class="bell icon"></i> Сповіщення
            <span class="ui red circular mini label notification-badge" style="display: none;"></span>
            <div class="menu notification-menu" id="notificationMenu">
                <div class="header">Сповіщення</div>
                <div class="item notification-mark-all" id="notificationMarkAll"><i class="check icon"></i> Позначити всі як прочитані</div>
                <div class="ui divider"></div>
                <div class="item">Завантаження...</div>
            </div>
        </div>
        <div class="item">Вітаю,&nbsp;<a href="/user/profile">{{ session.user.first_name }}</a></div>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block mobile_menu %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/billing/contracts">Контракти</a>
        <a class="item" href="/admin/kpi_definitions">Налаштування KPI</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <a class="item" href="/admin/clinical">Клінічні довідники</a>
        <a class="item" href="/admin/auth_configs">Налаштування авторизації</a>
        {# Notification Dropdown for Mobile #}
        <div class="ui dropdown item" id="notificationDropdownMobile">
            <i class="bell icon"></i> Сповіщення
            <span class="ui red circular mini label notification-badge" style="display: none;"></span>
            <div class="menu notification-menu" id="notificationMenuMobile">
                <div class="header">Сповіщення</div>
                <div class="item notification-mark-all" id="notificationMarkAllMobile"><i class="check icon"></i> Позначити всі як прочитані</div>
                <div class="ui divider"></div>
                <div class="item">Завантаження...</div>
            </div>
        </div>
        <div class="ui fitted divider"></div>
        <a class="item" href="/user/profile">Мій профіль</a>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block sidebar %}
    {% if session.user is defined %}
        <a class="item" href="/dashboard">Панель</a>
        <a class="item" href="/patients">Пацієнти</a>
        <a class="item" href="/appointments">Записи</a>
        <a class="item" href="/medical-records">Медичні записи</a>
        <a class="item" href="/prescriptions">Рецепти</a>
        <a class="item" href="/inventory">Склад</a>
        <a class="item" href="/billing">Рахунки</a>
        <a class="item" href="/billing/contracts">Контракти</a>
        <a class="item" href="/admin/kpi_definitions">Налаштування KPI</a>
        <a class="item" href="/admin/users">Користувачі</a>
        <a class="item" href="/admin/clinical">Клінічні довідники</a>
        <a class="item" href="/admin/auth_configs">Налаштування авторизації</a>
        <div class="ui fitted divider"></div>
        <a class="item" href="/user/profile">Мій профіль</a>
        <a class="item" href="/logout">Вихід</a>
    {% else %}
        <a class="item" href="/login">Вхід</a>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <style>
        .notification-item.unread .header {
            font-weight: 700;
        }
        .notification-menu {
            min-width: 320px;
            width: min(360px, 90vw);
            max-width: 420px;
            padding: 6px 0;
        }
        .notification-menu .item.notification-mark-all {
            font-weight: 600;
            color: #1b1c1d;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9fafb;
            cursor: pointer;
        }
        .notification-menu .item.notification-mark-all i.check.icon {
            color: #21ba45;
        }
        .notification-menu .item.notification-mark-all:hover {
            background: #f1f2f3;
        }
        .notification-menu .notification-item .content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            white-space: normal;
            word-break: break-word;
        }
        .notification-menu .notification-item .description {
            font-size: 11px;
            color: #767676;
        }
        .notification-menu .notification-item i.bell.outline.icon {
            color: #f2711c;
        }
        .notification-menu .notification-item .header {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: flex-start;
        }
        .notification-menu .notification-item .notification-dismiss {
            cursor: pointer;
            color: #767676;
            font-weight: 700;
        }
        .notification-menu .notification-item .notification-dismiss:hover {
            color: #db2828;
        }
        @media (max-width: 767px) {
            .notification-menu {
                width: 100%;
                min-width: 280px;
            }
        }
    </style>
    <script>
        $(document).ready(function() {
            $('.message .close').on('click', function() {
                $(this).closest('.message').transition('fade');
            });

            // Initialize notification dropdowns
            $('#notificationDropdown').dropdown();
            $('#notificationDropdownMobile').dropdown();

            let notificationPage = 1;
            const pageSize = 10;
            let hasMore = false;

            function updateBadge(count) {
                $('.notification-badge').each(function() {
                    if (count > 0) {
                        $(this).text(count).show();
                    } else {
                        $(this).text('').hide();
                    }
                });
            }

            function fetchNotifications(reset = true) {
                if (reset) {
                    notificationPage = 1;
                }
                const params = new URLSearchParams({
                    page: notificationPage,
                    limit: pageSize
                });

                fetch('/api/notifications?' + params.toString())
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        hasMore = !!data.has_more;
                        updateBadge(data.unread_count ?? 0);
                        updateNotificationDropdown(data.notifications ?? [], reset);
                    })
                    .catch(error => {
                        console.error('Error fetching notifications:', error);
                        // Optionally display an error message in the dropdown
                    });
            }

            function formatDate(value) {
                try {
                    return new Date(value + 'Z').toLocaleString();
                } catch (e) {
                    return value;
                }
            }

            function updateNotificationDropdown(notifications, reset) {
                const menu = $('#notificationMenu');
                const mobileMenu = $('#notificationMenuMobile');
                if (reset) {
                    menu.find('.item:not(.header):not(.divider):not(.notification-mark-all)').remove();
                    mobileMenu.find('.item:not(.header):not(.divider):not(.notification-mark-all)').remove();
                }

                if (notifications.length > 0) {
                    notifications.forEach(notification => {
                        const unreadClass = notification.is_read ? '' : 'unread';
                        const notificationItem = `
                            <div class="item notification-item ${unreadClass}" data-id="${notification.id}">
                                <div class="content">
                                    <div class="header">
                                        ${notification.message}
                                        <span class="notification-dismiss" title="Видалити">&times;</span>
                                    </div>
                                    <div class="description">${formatDate(notification.created_at)}</div>
                                </div>
                            </div>
                        `;
                        menu.append(notificationItem);
                        mobileMenu.append(notificationItem);
                    });
                }

                // Empty state if nothing at all
                if (menu.find('.notification-item').length === 0) {
                    const noNotificationItem = `
                        <div class="item">
                            <div class="content">
                                <div class="description">Немає сповіщень</div>
                            </div>
                        </div>
                    `;
                    menu.append(noNotificationItem);
                    mobileMenu.append(noNotificationItem);
                }

                // Manage "load more"
                menu.find('.notification-load-more').remove();
                mobileMenu.find('.notification-load-more').remove();
                if (hasMore) {
                    const loadMore = `<div class="item notification-load-more"><i class="angle down icon"></i> Показати ще</div>`;
                    menu.append(loadMore);
                    mobileMenu.append(loadMore);
                }
            }

            function markNotificationsAsRead() {
                fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // Empty body for POST request
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateBadge(0);
                        // Mark current items as read visually
                        $('#notificationMenu .notification-item').removeClass('unread');
                        $('#notificationMenuMobile .notification-item').removeClass('unread');
                        // Optionally show empty state when dropdown opens again
                        // fetchNotifications();
                    }
                })
                .catch(error => {
                    console.error('Error marking notifications as read:', error);
                });
            }

            $('#notificationMarkAll, #notificationMarkAllMobile').on('click', function() {
                markNotificationsAsRead();
            });

            $(document).on('click', '.notification-load-more', function() {
                notificationPage += 1;
                fetchNotifications(false);
            });

            $(document).on('click', '.notification-dismiss', function(event) {
                event.stopPropagation();
                const item = $(this).closest('.notification-item');
                const id = item.data('id');
                if (!id) {
                    item.remove();
                    return;
                }

                fetch('/api/notifications/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        item.remove();
                        // Recompute badge: if unread item removed, refetch count
                        fetchNotifications(true);
                    }
                })
                .catch(() => {
                    item.remove(); // fallback to remove locally
                });
            });

            // Fetch notifications on page load
            fetchNotifications();

            // Optionally, fetch notifications periodically
            // setInterval(fetchNotifications, 60000); // every 60 seconds
        });
    </script>
{% endblock %}
